---
description: >
  Notify Sentry.io of a release and deployment within your codebase
executor: default_small
parameters:
  sentry_org:
    type: string
    default: ministryofjustice
  sentry_project:
    type: string
  sentry_environment:
    type: string
steps:
  - checkout
  - mem/recall:
      env_var: APP_VERSION
  - run:
      name: Sentry - Create a release and notify of deployment
      command: |
        export SENTRY_ORG=<< parameters.sentry_org >>
        export SENTRY_PROJECT=<< parameters.sentry_project >>
        curl -sL https://sentry.io/get-cli/ | bash
        sentry-cli releases new $APP_VERSION --project $SENTRY_PROJECT
        sentry-cli releases set-commits $APP_VERSION --auto
        sentry-cli releases finalize $APP_VERSION
        sentry-cli releases deploys $APP_VERSION new -e << parameters.sentry_environment >>
